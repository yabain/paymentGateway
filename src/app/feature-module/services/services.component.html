<div class="page-header">
    <div class="content-page-header page-tilte">
        <!-- <h5 *ngIf="!isAdmin" style="color: black !important;">
            {{ 'services.title' | translate }}
        </h5>
        <h5 *ngIf="isAdmin" style="color: black !important;">
            {{ 'services.allServices' | translate }}
        </h5> -->
        <div class="page-content">
            <div class="list-btn">
                <ul class="filter-list">
                    <li *ngIf="activeSearch">
                        <div class="form-custom">
                            <input [(ngModel)]="searchString" (input)="searchData(searchString)" type="text"
                                class="form-control" id="member_search1" placeholder="Search Customer">
                        </div>
                    </li>
                    <li *ngIf="activeSearch">
                        <a class="btn-filters btn-hover" href="javascript:void(0);" matTooltip="Close Research"
                            (click)="toggleSearch()">
                            <span><i class="feather icon-x"></i></span>
                        </a>
                    </li>
                    <li *ngIf="!activeSearch">
                        <a class="btn-filters btn-hover" href="javascript:void(0);" matTooltip="Research plan"
                            (click)="activeSearch = true">
                            <span><img src="assets/img/icons/search.svg" alt="img" style="color: #021d66;"></span>
                        </a>
                    </li>
                    <li>
                        <button class="btn btn-rounded btn-outline-secondary me-1" (click)="copyUrl()">
                            <i class="feather icon-share-2"></i>
                            {{ 'action.share' | translate }}
                        </button>
                    </li>
                    <li>
                        <a class="btn-filters btn-hover" data-bs-toggle="tooltip" data-bs-placement="bottom"
                            matTooltip="List-View"><span><i class="feather icon-list"></i></span></a>
                    </li>
                    <li>
                        <a class="btn-filters btn-hover" href="javascript:void(0);" data-bs-toggle="tooltip"
                            data-bs-placement="bottom" matTooltip="Refresh" (click)="refresh()"><span><i
                                    class="feather icon-refresh-ccw"></i></span></a>
                    </li>

                    <li *ngIf="currentUser && !idParam">
                        <a class="btn btn-primary" href="javascript:void(0);" data-bs-toggle="modal"
                            data-bs-target="#add_service"><i class="fa fa-plus-circle me-2" aria-hidden="true"></i>{{
                            'services.addService' | translate }}</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- /Page Header -->

<div class="row d-flex align-items-center justify-content-center"
    *ngIf="!watingServicesList && servicesList?.length >= 1">
    <div class="col-sm-12 col-md-6 col-lg-6 col-xl-3" *ngFor="let service of servicesList" style="text-align: center !important;">
        <!-- <div class="packages card">
            <app-item [plan]="plan"
                (click)="navigateTo('/subscription/details/' + plan._id)"></app-item>
            <div class="d-flex justify-content-center package-edit">
                <button type="button" (click)="selectPlan(plan)" type="button" class="btn btn-secondary mt-1 me-1"
                    data-bs-toggle="modal" data-bs-target="#package_details">
                    <i class="feather icon-menu"></i>
                </button>
                <button class="btn btn-rounded btn-primary me-1" *ngIf="!isAuthor(plan) && plan.isActive"
                    (click)="checkSbscriberStatus(plan)" data-bs-toggle="modal" data-bs-target="#subscriptionModal">{{
                    'subscriptions.subscribe' | translate }}</button>
            </div>
        </div> -->

        <div class="card">
            <app-candidate *ngIf="currentUser && isElection && currentUser.email != 'dkuser123@email.com'" [service]="service" (click)="navigateTo('/services/details/' + service._id)"></app-candidate>
            <app-candidate *ngIf="!currentUser && isElection || currentUser.email === 'dkuser123@email.com'" [service]="service"></app-candidate>

            <app-item *ngIf="currentUser && !isElection && currentUser.email != 'dkuser123@email.com'" [service]="service" (click)="navigateTo('/services/details/' + service._id)"></app-item>
            <app-item *ngIf="!currentUser && !isElection" [service]="service"></app-item>
            <!-- <div [ngClass]="service?.isActive === true ? 'badge-success':  'badge-error'"
                *ngIf="currentUser && isAuthor(service) || currentUser && isAdmin">
            </div> -->
            <div *ngIf="!watingServicesListStat && !service.test"> {{returnQuantity(service._id)}} Votes</div>
            <div class="d-flex justify-content-center package-edit" style="padding: 5px;">
                <button type="button" (click)="selectService(service)" type="button" class="btn btn-secondary mt-1 me-1"
                    data-bs-toggle="modal" data-bs-target="#package_details">
                    <i class="feather icon-menu"></i>
                </button>
                <button class="btn btn-rounded btn-primary me-1" *ngIf="service.isActive && currentUser"
                    (click)="checkSbscriberStatus(service)" data-bs-toggle="modal"
                    data-bs-target="#subscriptionModal">
                    {{ ('services.' + (isElection ? 'vote' : 'pay')) | translate }}
                    </button>
                <button class="btn btn-rounded btn-primary me-1" *ngIf="!currentUser"
                    (click)="navigateTo('/auth/login')">
                    {{ (isElection === true ? 'services.loginToVote' : 'services.loginToPay') | translate }}</button>
            </div>
        </div>

        <!-- <div class="card" *ngFor="let plan of servicesList">
            <div class="card-image">
                <img src="https://i.pinimg.com/1200x/3f/20/7c/3f207cedc0a28a24ce344483bfe91b8c.jpg" alt="Description de l'image">
            </div>
            <div class="card-content">
                <h2 class="card-title">Titre de la Carte</h2>
                <p class="card-description">Ceci est un exemple de texte qui se trouve sous l'image de la carte. Vous pouvez mettre ici une courte description, un résumé ou les détails d'un profil.</p>
                <a href="#" class="card-link">En savoir plus</a>
            </div>
        </div>
        <div class="card">
            <div class="card-image">
                <img src="https://i.pinimg.com/736x/c5/a7/f4/c5a7f4589255b54bf7be6f7637a9d204.jpg" alt="Description de l'image">
            </div>
            <div class="card-content">
                <h2 class="card-title">Titre de la Carte</h2>
                <p class="card-description">Ceci est un exemple de texte qui se trouve sous l'image de la carte. Vous pouvez mettre ici une courte description, un résumé ou les détails d'un profil.</p>
                <a href="#" class="card-link">En savoir plus</a>
            </div>
        </div> -->

    </div>
</div>

<!-- Nothing to show -->
<div class="row d-flex align-items-center justify-content-center"
    *ngIf="!watingServicesList && servicesList?.length < 1">
    <div style="display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;">
        <img src="../../../../assets/img/ressorces/nts.png" alt="" style="max-width: 150px;
        height: auto;">
        <br>
        {{ "nts" | translate }}
        <br><br>
        <!-- <a class="btn btn-primary m-2" href="javascript:void(0);" data-bs-toggle="modal"
            data-bs-target="#add_service"><i class="fa fa-plus-circle me-2" aria-hidden="true"></i>{{
            'subscriptions.add' | translate }}</a> -->
    </div>
</div>

<div class="row d-flex align-items-center justify-content-center" *ngIf="watingServicesList">
    <div style="display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;">
        <div class="spinner-border" role="status"></div>
    </div>
</div>

<!-- Add New Service Modal -->
<div class="modal custom-modal fade p-20" id="add_service" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <div class="form-header modal-header-title text-start mb-0">
                    <h4 class="mb-0">{{ 'services.add' | translate }}</h4>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="img-upload">
                                <div class="profile-img company-profile-img">
                                    <img id="company-img" class="img-fluid me-0" src="assets/img/icons/price-01.svg"
                                        (click)="selectImg('assets/img/icons/price-01.svg')" alt="profile-img">
                                </div>
                                <div class="profile-img company-profile-img">
                                    <img id="company-img" class="img-fluid me-0" src="assets/img/icons/price-02.svg"
                                        (click)="selectImg('assets/img/icons/price-02.svg')" alt="profile-img">
                                </div>
                                <div class="profile-img company-profile-img">
                                    <img id="company-img" class="img-fluid me-0" src="assets/img/icons/price-03.svg"
                                        (click)="selectImg('assets/img/icons/price-03.svg')" alt="profile-img">
                                </div>
                                <div class="profile-img company-profile-img">
                                    <img id="company-img" class="img-fluid me-0" src="assets/img/icons/price-04.svg"
                                        (click)="selectImg('assets/img/icons/price-04.svg')" alt="profile-img">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="profile-picture">
                                <div class="upload-profile">
                                    <div class="profile-img company-profile-img">
                                        <img id="company-img" class="img-fluid me-0" [src]="imageUrl" alt="profile-img">
                                    </div>
                                    <div class="add-profile">
                                        <h5>{{title}}</h5>
                                        <span>{{subTitle}}</span>
                                    </div>
                                </div>
                                <div class="img-upload">
                                    <!-- <label class="btn btn-upload">
                                        Upload <input type="file">
                                    </label>
                                    <a class="btn btn-remove">Remove</a> -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <h5 class="form-title mb-3">{{ "services.info" | translate }}</h5>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="input-block mb-3">
                                <label>{{ "subscriptions.name" | translate }}</label>
                                <input type="text" class="form-control" 
                                    [class.is-invalid]="submitted && form.get('title')?.invalid"
                                    placeholder="" formControlName="title" (input)="updateTitle()">
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="input-block mb-3">
                                <label>{{ "subscriptions.subTitle" | translate }}</label>
                                <input type="text" class="form-control" 
                                    [class.is-invalid]="submitted && form.get('subTitle')?.invalid"
                                    placeholder="" formControlName="subTitle" (input)="updateTitle()">
                            </div>
                        </div>
                        <h6>{{ "subscriptions.optionTitle" | translate }}</h6>
                        <div class="col-sm-12 col-md-12" formArrayName="options">
                            <div class="option-space" *ngFor="let option of optionsList.controls; let i = index"
                                [formGroupName]="i">
                                <div class="row">
                                    <div class="col-sm-12 col-md-6">
                                        <div class="input-block mb-3">
                                            <input type="text" class="form-control" placeholder=""
                                                formControlName="title" [id]="'title' + i">
                                        </div>
                                    </div>
                                    <div class="col-sm-12 col-md-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <h6 class="mb-0">{{ "subscriptions.checkIfAvailable" | translate }}</h6>
                                            <div class="status-toggle">
                                                <input [id]="'isActive' + i" formControlName="isActive" class="check"
                                                    type="checkbox">
                                                <label [for]="'isActive' + i" class="checktoggle checkbox-bg">{{
                                                    "subscriptions.status" | translate }}</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12 col-md-2">
                                        <button type="button" class="btn btn-block btn-outline-light active"
                                            [disabled]="i < 1" (click)="removeTicketClass(i)">
                                            <i class="fa fa-trash me-2" aria-hidden="true" style="color: #d00101;"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-3">
                            <div class="input-block mb-3">
                                <label></label>
                                <a class="btn btn-primary" href="javascript:void(0);" (click)="addOptions()"><i
                                        class="fa fa-plus me-2" aria-hidden="true"></i> {{ "subscriptions.addOption" |
                                    translate }}</a>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-12">
                            <div class="input-block mb-3">
                                <label>{{ "subscriptions.description" | translate }}</label>
                                <textarea type="text" class="form-control" 
                                    [class.is-invalid]="submitted && form.get('description')?.invalid"
                                    placeholder="Enter Description" formControlName="description"></textarea>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-6">
                            <div class="input-block mb-3">
                                <label class="d-flex justify-content-between">
                                    <span>{{ "subscriptions.price" | translate }}</span>
                                    <span class="text-primary"><i class="fa-solid fa-circle-exclamation me-2"></i>
                                        {{ currentUser?.countryId.currency }}</span>
                                </label>
                                <div class="input-group">
                                    <input class="form-control" style="text-align: right" type="text" id="price"
                                        [class.is-invalid]="submitted && form.get('price')?.invalid"
                                        placeholder="" formControlName="price" (input)="formatAmount($event)" />
                                    <!-- <span class="input-group-text">{{ currentUser?.countryId.currency }}</span> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-bs-dismiss="modal" class="btn btn-back cancel-btn me-2"
                        *ngIf="!watingCreation" (close)="ngOnDestroy()">{{ "action.cancel" | translate }}</button>
                    <button type="submit" class="btn btn-primary paid-continue-btn" [disabled]="watingCreation"
                        *ngIf="!watingCreation">
                        {{ "subscriptions.create" | translate }}</button>
                    <button class="btn btn-primary paid-continue-btn" [disabled]="watingCreation"
                        *ngIf="watingCreation">
                        <div class="spinner-border" role="status"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- /Add New Package Modal -->

<!-- Delete Items Modal -->
<div class="modal custom-modal fade modal-delete" id="delete_modal" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-header">
                    <div class="">
                        <span><i class="feather icon-trash" style="color: red; width: 100px !important;"></i></span>
                    </div>
                    <h3>{{ "subscriptions.deletePlan" | translate }} ?</h3>
                    <p>{{ "subscriptions.wantDeletePlan" | translate }} <b>{{selectedService?.title}}</b></p>
                </div>
                <div class="modal-btn delete-action">
                    <div class="modal-footer justify-content-center p-0">
                        <button type="submit" (click)="deleteService(selectedService._id)" class="btn btn-danger m-1">{{
                            "action.delete" | translate }}</button>
                        <button type="button" data-bs-dismiss="modal" class="btn btn-primary m-1"
                            (close)="ngOnDestroy()">{{ "action.cancel"
                            | translate }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /Delete Items Modal -->

<!-- Package details modal content -->
<div class="modal custom-modal fade modal-delete" id="package_details" role="dialog">
    <div class="modal-dialog modal-sm modal-right">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-left" *ngIf="selectedService">
                    <app-candidate [service]="selectedService"></app-candidate>
                    <br>
                    <ul>
                        <li *ngFor="let option of optionsData" style="margin-bottom: 5px;">
                            <span *ngIf="option.isActive"><i class="fa-solid fa-circle-check"></i> {{ option.title
                                }}</span>
                            <span *ngIf="!option.isActive"><i class="feather icon-x-circle"></i><s> {{ option.title
                                    }}</s></span>
                        </li>
                    </ul>
                    <p>
                        {{ selectedService?.description}}
                    </p>
                    <div style="text-align: left"> {{ "subscriptions.author" | translate }}: <b>{{
                            showName(selectedService?.author) }}</b></div><br>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        {{ "action.close" | translate }}
                    </button>
                </div>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
</div>

<div class="modal fade" id="subscriptionModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" *ngIf="!goToProceed">
            <div class="modal-header">
                <h5 class="modal-title align-items-center justify-content-center" id="staticBackdropLabel">
                    {{ selectedService?.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                    (close)="ngOnDestroy()"></button>
            </div>
            <div class="modal-body">
                <span style="font-size: 1rem; margin-bottom: 20px;" *ngIf="!checkingSubscriptionStatus">{{
                    selectedService?.subTitle }}</span>
                <h2 *ngIf="selectedService?.price > 0">{{ selectedService?.price }} {{ selectedService?.currency }}</h2>
                <h2 *ngIf="selectedService?.price === 0">{{ "item.free" | translate }}</h2>
                <ul>
                    <li *ngFor="let option of optionsData" style="margin-bottom: 5px;">
                        <span *ngIf="option.isActive"><i class="fa-solid fa-circle-check"></i> {{ option.title
                            }}</span>
                        <span *ngIf="!option.isActive"><i class="feather icon-x-circle"></i><s> {{ option.title
                                }}</s></span>
                    </li>
                </ul>
                <br><label htmlFor="bankCode" *ngIf="!checkingSubscriptionStatus && !isSubscriber">{{
                    "subscriptions.quantity" | translate }}</label>

                <input [(ngModel)]="quantity" (input)="onQuantity()" type="number" class="form-control"
                    id="member_search1" placeholder="Search Customer" [disabled]="proceed">
                <br>
                <div class="step3">
                    <div *ngIf="checkingSubscriptionStatus">
                        <div style="display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 300px;">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    </div>

                    <div *ngIf="!checkingSubscriptionStatus && isSubscriber" style="text-align: center;">
                        <div class="fee-breakdown">
                            {{ "services.alreadyVoteMsg" | translate }}
                        </div>
                        <button type="button" class="btn btn-primary btn-lg me-1 mb-2" style="padding: 5px;"
                            (click)="isSubscriber = false">{{ "services.payAgain" | translate }}</button>
                    </div>
                    <div *ngIf="!checkingSubscriptionStatus && !isSubscriber">
                        <div class="fee-breakdown">
                            <h4><i class="fas fa-receipt"></i> {{ "subscriptions.summary" | translate }}</h4>
                            <div class="fee-item">
                                <span>
                                    {{ 'payment.amount' | translate }}:
                                    {{ selectedService?.price }}
                                    {{ selectedService?.currency }}</span>
                            </div>
                            <div class="fee-item">
                                <span>{{ "subscriptions.quantity" | translate }}</span>
                                <span> {{ quantity }}
                                </span>
                            </div>
                            <div class="fee-item">
                                <span>{{ "payment.taxes" | translate }} ≈ </span>
                                <span>
                                    {{ taxesAmount }}
                                    {{ selectedService?.currency }}</span>
                            </div>
                            <div class="fee-total">
                                <span>{{ "payment.total" | translate }}</span>
                                <span>
                                    {{ paymentWithTaxes }}
                                    {{ selectedService?.currency }}</span>
                            </div>
                        </div>

                        <div class="security-notice" *ngIf="currentUser">
                            <img src="assets/img/ressorces/flutterwave.png" alt=""
                                style="max-width: 100px; border-radius: 5px; margin-right: 10px;">
                            <p>{{ "payment.secureMessage" | translate }}</p>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-cancel" data-bs-dismiss="modal" (close)="ngOnDestroy()"
                                *ngIf="!checkingSubscriptionStatus && !proceed">
                                {{ "action.close" | translate }}
                            </button>
                            <button class="btn2 btn-confirm"
                                *ngIf="!checkingSubscriptionStatus && !isSubscriber && !proceed && quantity > 0"
                                (click)="pay()" [disabled]="quantity < 1">
                                <i class="fas fa-check"></i> {{ "payment.proceed" | translate }}
                            </button>
                        </div>
                        <div class="row d-flex align-items-center justify-content-center" style="justify-content: center;
                        align-items: center;" *ngIf="proceed">
                            <div class="spinner-border" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-content" *ngIf="goToProceed">
            <div class="row">
                <div class="col-md-12">
                    <div class="wating-msg">
                        <img src="assets/img/ressorces/loader.gif" alt="" style="max-width: 50px; margin-right: 10px;"
                            *ngIf="!modalClosed && !transactionSucceded && !transactionFailed">
                        <!-- <div class="spinner-border" role="status" *ngIf="!modalClosed && !transactionSucceded && !transactionFailed"></div> -->
                        <p style="margin-top: 50px;" *ngIf="!modalClosed && !transactionSucceded && !transactionFailed">
                            {{ "payment.processing-message1" | translate }}<br>
                            {{ "payment.processing-message2" | translate }}
                        </p>


                        <img src="../../../assets/img/ressorces/tfailed.gif" alt="" style="max-width: 100px;;"
                            *ngIf="!reOpen && transactionFailed">
                        <br>
                        <span style="color: red !important" *ngIf="!reOpen && transactionFailed">{{
                            "payment.transactionFailed" | translate }}</span>
                        <p style="margin-top: 50px;" *ngIf="!reOpen && transactionFailed">
                            Click
                            <span class="retry" (click)="openPayin()" *ngIf="!reOpen && transactionFailed">{{
                                "payment.hereToRetry" | translate
                                }}.</span>
                            <span *ngIf="reOpen && transactionFailed">{{ "payment.hereToRetry" | translate }}. {{
                                "payment.opening" | translate }}...</span>
                        </p>

                        <img src="assets/img/ressorces/flutterwave.png" alt="" style="max-width: 100px;;"
                            *ngIf="!transactionSucceded && !transactionFailed">
                        <p style="margin-top: 50px;" *ngIf="showRetry && !transactionSucceded && !transactionFailed">
                            {{ "payment.processing-message4" | translate }}
                            <span class="retry" (click)="openPayin()" *ngIf="!reOpen && !transactionSucceded">{{
                                "payment.hereToRetry" | translate
                                }}.</span>
                            <span *ngIf="reOpen && !transactionSucceded">{{ "payment.hereToRetry" | translate }}. {{
                                "payment.opening" | translate }}...</span>
                        </p>

                        <img src="assets/img/ressorces/paymentDone.gif" alt="" style="max-width: 250px;;"
                            *ngIf="transactionSucceded && !transactionFailed">
                        <p style="margin-top: 50px;" *ngIf="transactionSucceded && !transactionFailed">{{
                            'payment.paymentSuccess'
                            | translate }}</p>

                        <p style="margin-top: 50px;"
                            *ngIf="!transactionSucceded && showRetry || !transactionSucceded && transactionSucceded">
                            <br>
                            {{ 'payment.ifPaymentConfirmed' | translate }}
                        </p>

                        <br>
                        <button class="btn btn-primary" *ngIf="showRetry || transactionSucceded" (click)="ngOnDestroy()"
                            data-bs-dismiss="modal"> {{ "action.close" | translate }} </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
